<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Amar Informatique</title>
<link rel="icon" href="logo.jpg" type="image/x-icon">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAUjSJTplPn9O8pK_YU5ydsyqUQ9HVfKXo",
  authDomain: "amar-informatique.firebaseapp.com",
  projectId: "amar-informatique",
  storageBucket: "amar-informatique.firebasestorage.app",
  messagingSenderId: "568367870390",
  appId: "1:568367870390:web:e1583c182272ecbf141117"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();
</script>
<style>
/* ... (Styles conserv√©s tels quels car ils sont corrects) ... */
:root {
  --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #818cf8;
  --secondary: #ec4899; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
  --bg-main: #0f172a; --bg-card: #1e293b; --bg-hover: #334155;
  --text-main: #f1f5f9; --text-muted: #94a3b8;
  --border: rgba(255,255,255,0.1); --radius: 12px; --radius-lg: 16px;
  --transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Inter',sans-serif; background:var(--bg-main); color:var(--text-main); min-height:100vh; }
header { background:rgba(30,41,59,0.8); backdrop-filter:blur(20px); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
.navbar { max-width:1600px; margin:0 auto; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
.logo h1 { font-size:1.5rem; font-weight:700; background:linear-gradient(135deg,var(--primary),var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.nav-items { display:flex; gap:1rem; align-items:center; }
.btn { padding:0.75rem 1.5rem; border:none; border-radius:var(--radius); font-weight:600; cursor:pointer; transition:var(--transition); display:inline-flex; align-items:center; gap:0.5rem; text-decoration:none; }
.btn-primary { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; }
.btn-secondary { background:var(--bg-hover); color:var(--text-main); border:1px solid var(--border); }
.btn-success { background:linear-gradient(135deg,var(--success),#059669); color:white; }
.btn-danger { background:linear-gradient(135deg,var(--danger),#dc2626); color:white; }
.btn-sm { padding:0.5rem 1rem; font-size:0.85rem; }
.admin-container { max-width:1600px; margin:0 auto; padding:2rem; }
.page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding-bottom:1.5rem; border-bottom:1px solid var(--border); flex-wrap:wrap; gap:1rem; }
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem; margin-bottom:2rem; }
.stat-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:1.5rem; transition:var(--transition); }
.filters-bar { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:1.5rem; margin-bottom:2rem; display:flex; gap:1rem; flex-wrap:wrap; align-items:center; }
.filter-group { display:flex; flex-direction:column; gap:0.5rem; flex:1; min-width:200px; }
.filter-input { padding:0.75rem 1rem; background:var(--bg-main); border:1px solid var(--border); border-radius:var(--radius); color:var(--text-main); }
.table-container { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); overflow:hidden; }
.orders-table { width:100%; border-collapse:collapse; }
.orders-table th { padding:1rem 1.5rem; text-align:left; font-size:0.85rem; font-weight:600; color:var(--text-muted); text-transform:uppercase; background:var(--bg-main); }
.orders-table td { padding:1.25rem 1.5rem; border-bottom:1px solid var(--border); }
.status-badge { display:inline-flex; align-items:center; gap:0.5rem; padding:0.4rem 0.8rem; border-radius:50px; font-size:0.75rem; font-weight:700; }
.status-pending { background:rgba(245,158,11,0.2); color:#fbbf24; }
.status-accepted { background:rgba(59,130,246,0.2); color:#60a5fa; }
.status-shipped { background:rgba(139,92,246,0.2); color:#a78bfa; }
.status-arrived { background:rgba(16,185,129,0.2); color:#34d399; }
.status-returned { background:rgba(239,68,68,0.2); color:#f87171; }
.action-buttons { display:flex; gap:8px; }
.btn-details { background:#6366f1; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:0.8rem; }
.btn-notify { background:#10b981; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:0.8rem; }
.btn-delete { background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:0.8rem; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); }
.modal.active { display:flex; align-items:center; justify-content:center; }
.modal-content { background:var(--bg-card); border-radius:var(--radius-lg); max-width:700px; width:95%; max-height:90vh; overflow-y:auto; padding:20px; }
.notification { position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:var(--radius); font-weight:600; z-index:9999; animation:slideIn 0.3s ease; background:var(--success); color:white; }
</style>
</head>
<body>

<header>
  <nav class="navbar">
    <div class="logo"><h1><i class="fas fa-chart-line"></i> Amar Dashboard</h1></div>
    <div class="nav-items">
      <a href="index.html" class="btn btn-secondary btn-sm"><i class="fas fa-store"></i> Boutique</a>
      <button class="btn btn-danger btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt"></i> D√©connexion</button>
    </div>
  </nav>
</header>

<main class="admin-container">
  <div class="page-header">
    <div class="page-title"><h1><i class="fas fa-shopping-bag"></i> Gestion des Commandes</h1></div>
    <div class="page-actions">
      <button class="btn btn-success" onclick="openAddProductModal()"><i class="fas fa-plus"></i> Ajouter Produit</button>
      <button class="btn btn-primary" onclick="exportCommandes()"><i class="fas fa-download"></i> Exporter CSV</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="stat-number" id="totalCommandes">0</div><div class="stat-label">Commandes Totales</div></div>
    <div class="stat-card"><div class="stat-number" id="totalRevenu">0 DA</div><div class="stat-label">Revenu Total</div></div>
    <div class="stat-card"><div class="stat-number" id="totalDomicile">0</div><div class="stat-label">Livraison Domicile</div></div>
    <div class="stat-card"><div class="stat-number" id="totalStopdesk">0</div><div class="stat-label">Stop Desk</div></div>
  </div>

  <div class="filters-bar">
    <div class="filter-group"><label>Rechercher</label><input type="text" id="searchInput" class="filter-input" placeholder="N¬∞ commande, client..."></div>
    <div class="filter-group"><label>Type</label><select id="filterType" class="filter-input"><option value="">Tous</option><option value="domicile">Domicile</option><option value="stopdesk">Stop Desk</option></select></div>
    <div class="filter-group"><label>Wilaya</label><select id="filterWilaya" class="filter-input"><option value="">Toutes</option></select></div>
    <div class="filter-group"><label>&nbsp;</label><button class="btn btn-secondary" onclick="clearFilters()">Reset</button></div>
  </div>

  <div class="table-container">
    <table class="orders-table">
      <thead><tr><th>N¬∞</th><th>Client</th><th>Type</th><th>Wilaya</th><th>Total</th><th>Statut</th><th>Actions</th></tr></thead>
      <tbody id="ordersTableBody"></tbody>
    </table>
  </div>
</main>

<div class="modal" id="detailModal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
      <h2>D√©tails: <span id="detailOrderNumber"></span></h2>
      <button class="btn-sm" onclick="closeDetail()">&times;</button>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
      <div>
        <p><strong>Client:</strong> <span id="detailName"></span></p>
        <p><strong>T√©l 1:</strong> <span id="detailPhone1"></span></p>
        <p><strong>T√©l 2:</strong> <span id="detailPhone2"></span></p>
      </div>
      <div>
        <p><strong>Wilaya:</strong> <span id="detailWilaya"></span></p>
        <p><strong>Commune:</strong> <span id="detailCommune"></span></p>
        <p><strong>Type:</strong> <span id="detailOrderType"></span></p>
      </div>
    </div>

    <div style="margin:20px 0; border:1px solid var(--border); padding:15px; border-radius:12px;">
      <h3>Statut Actuel: <span id="detailStatusBadge" class="status-badge"></span></h3>
      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <button class="btn btn-sm" style="background:#3b82f6" onclick="updateOrderStatus('accepted')">Accepter</button>
        <button class="btn btn-sm" style="background:#8b5cf6" onclick="updateOrderStatus('shipped')">Exp√©dier</button>
        <button class="btn btn-sm" style="background:#10b981" onclick="updateOrderStatus('arrived')">Livr√©e</button>
        <button class="btn btn-sm" style="background:#ef4444" onclick="updateOrderStatus('returned')">Retour</button>
      </div>
    </div>

    <div id="detailItems" style="margin-top:20px;"></div>
    
    <div style="text-align:right; margin-top:20px; font-size:1.2rem; font-weight:bold;">
      Total: <span id="detailTotal" style="color:var(--success)"></span>
    </div>
  </div>
</div>

<div class="modal" id="addProductModal">
  <div class="modal-content">
    <h2>Ajouter un Produit</h2>
    <form id="addProductForm">
        <input type="text" id="productName" placeholder="Nom du produit" class="filter-input" style="width:100%; margin-bottom:10px;" required>
        <select id="productCategory" class="filter-input" style="width:100%; margin-bottom:10px;" required>
            <option value="laptop">Laptop</option>
            <option value="imprimantes">Imprimantes</option>
            <option value="accessoires">Accessoires</option>
        </select>
        <input type="number" id="productPrice" placeholder="Prix DA" class="filter-input" style="width:100%; margin-bottom:10px;" required>
        <textarea id="productDescription" placeholder="Description" class="filter-input" style="width:100%; margin-bottom:10px;"></textarea>
        <input type="file" id="productImageFile" class="filter-input" style="width:100%; margin-bottom:10px;" required>
        <div id="imagePreview"></div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button type="submit" class="btn btn-success">Enregistrer</button>
            <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">Annuler</button>
        </div>
    </form>
  </div>
</div>

<script>
let allCommandes = [];

// ========== CHARGEMENT ==========
function loadCommandes() {
  const tbody = document.getElementById('ordersTableBody');
  tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">Chargement...</td></tr>';
  
  db.collection("commandes").orderBy("date","desc").onSnapshot(snapshot => {
    allCommandes = [];
    snapshot.forEach(doc => allCommandes.push({id:doc.id, ...doc.data()}));
    displayCommandes(allCommandes);
    updateStats();
    initializeWilayaFilter();
  });
}

// ========== AFFICHAGE ==========
function displayCommandes(commandes) {
  const tbody = document.getElementById('ordersTableBody');
  tbody.innerHTML = commandes.map(cmd => `
    <tr>
      <td>${cmd.orderNumber || '‚Äî'}</td>
      <td>${cmd.firstName || ''} ${cmd.lastName || ''}</td>
      <td>${cmd.orderType === 'domicile' ? 'üè† Domicile' : 'üè™ Stop Desk'}</td>
      <td>${cmd.wilaya || '‚Äî'}</td>
      <td>${(cmd.grandTotal || 0).toFixed(2)} DA</td>
      <td><span class="status-badge ${getStatusClass(cmd.status || 'pending')}">${getStatusLabel(cmd.status || 'pending')}</span></td>
      <td>
        <div class="action-buttons">
          <button class="btn-details" onclick="showDetail('${cmd.orderNumber}')"><i class="fas fa-eye"></i></button>
          <button class="btn-notify" onclick="sendStatusNotification('${cmd.id}')"><i class="fab fa-whatsapp"></i></button>
          <button class="btn-delete" onclick="deleteCommande('${cmd.orderNumber}')"><i class="fas fa-trash"></i></button>
        </div>
      </td>
    </tr>
  `).join('');
}

// ========== ACTIONS ==========
function showDetail(orderNumber) {
  const cmd = allCommandes.find(c => String(c.orderNumber) === String(orderNumber));
  if (!cmd) return;
  
  const modal = document.getElementById('detailModal');
  modal.dataset.firebaseId = cmd.id;
  modal.dataset.currentOrderNumber = orderNumber;
  
  document.getElementById('detailOrderNumber').textContent = cmd.orderNumber;
  document.getElementById('detailName').textContent = `${cmd.firstName} ${cmd.lastName}`;
  document.getElementById('detailPhone1').textContent = cmd.phone1;
  document.getElementById('detailPhone2').textContent = cmd.phone2 || '‚Äî';
  document.getElementById('detailWilaya').textContent = cmd.wilaya;
  document.getElementById('detailCommune').textContent = cmd.commune;
  document.getElementById('detailOrderType').textContent = cmd.orderType;
  document.getElementById('detailTotal').textContent = (cmd.grandTotal || 0).toFixed(2) + " DA";
  
  const badge = document.getElementById('detailStatusBadge');
  badge.textContent = getStatusLabel(cmd.status);
  badge.className = 'status-badge ' + getStatusClass(cmd.status);
  
  modal.classList.add('active');
}

function updateOrderStatus(newStatus) {
  const modal = document.getElementById('detailModal');
  const fid = modal.dataset.firebaseId;
  if(!fid) return;

  db.collection("commandes").doc(fid).update({ status: newStatus })
    .then(() => {
      showNotification("Statut mis √† jour !");
      showDetail(modal.dataset.currentOrderNumber);
    });
}

function sendStatusNotification(id) {
  const cmd = allCommandes.find(c => c.id === id);
  if(!cmd) return;

  const status = getStatusLabel(cmd.status);
  const message = `Bonjour ${cmd.firstName}, l'√©tat de votre commande N¬∞${cmd.orderNumber} est d√©sormais : ${status}. Suivez-la ici: ${window.location.origin}/tracking.html?order=${cmd.orderNumber}`;
  
  const phone = cmd.phone1.replace(/\s/g, '');
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
}

// ========== UTILS ==========
function getStatusClass(s) {
  const classes = { pending:'status-pending', accepted:'status-accepted', shipped:'status-shipped', arrived:'status-arrived', returned:'status-returned' };
  return classes[s] || 'status-pending';
}

function getStatusLabel(s) {
  const labels = { pending:'‚è≥ En attente', accepted:'‚úì Accept√©e', shipped:'üöö En route', arrived:'üì¶ Livr√©e', returned:'‚Ü©Ô∏è Retourn√©e' };
  return labels[s] || '‚è≥ En attente';
}

function showNotification(msg) {
  const n = document.createElement('div');
  n.className = 'notification';
  n.textContent = msg;
  document.body.appendChild(n);
  setTimeout(() => n.remove(), 3000);
}

function closeDetail() { document.getElementById('detailModal').classList.remove('active'); }
function openAddProductModal() { document.getElementById('addProductModal').classList.add('active'); }
function closeAddProductModal() { document.getElementById('addProductModal').classList.remove('active'); }

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', loadCommandes);

// S√©curit√©
if(sessionStorage.getItem('adminLogged') !== 'true') window.location.href='login.html';
function logout() { sessionStorage.removeItem('adminLogged'); window.location.href='login.html'; }
</script>
</body>
</html>
