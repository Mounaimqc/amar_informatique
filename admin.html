<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Amar Informatique</title>
<link rel="icon" href="logo.jpg" type="image/x-icon">
<!-- Google Fonts - ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Firebase - ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑ -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAUjSJTplPn9O8pK_YU5ydsyqUQ9HVfKXo",
  authDomain: "amar-informatique.firebaseapp.com",
  projectId: "amar-informatique",
  storageBucket: "amar-informatique.firebasestorage.app",
  messagingSenderId: "568367870390",
  appId: "1:568367870390:web:e1583c182272ecbf141117"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();
</script>
<style>
:root {
  --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #818cf8;
  --secondary: #ec4899; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
  --bg-main: #0f172a; --bg-card: #1e293b; --bg-hover: #334155;
  --text-main: #f1f5f9; --text-muted: #94a3b8;
  --border: rgba(255,255,255,0.1); --radius: 12px; --radius-lg: 16px;
  --transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Inter',sans-serif; background:var(--bg-main); color:var(--text-main); min-height:100vh; }

header { background:rgba(30,41,59,0.8); backdrop-filter:blur(20px); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
.navbar { max-width:1600px; margin:0 auto; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
.logo h1 { font-size:1.5rem; font-weight:700; background:linear-gradient(135deg,var(--primary),var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.nav-items { display:flex; gap:1rem; align-items:center; }

.btn { padding:0.75rem 1.5rem; border:none; border-radius:var(--radius); font-weight:600; cursor:pointer; transition:var(--transition); display:inline-flex; align-items:center; gap:0.5rem; text-decoration:none; }
.btn-primary { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; }
.btn-secondary { background:var(--bg-hover); color:var(--text-main); border:1px solid var(--border); }
.btn-success { background:linear-gradient(135deg,var(--success),#059669); color:white; }
.btn-danger { background:linear-gradient(135deg,var(--danger),#dc2626); color:white; }
.btn-sm { padding:0.5rem 1rem; font-size:0.85rem; }

.admin-container { max-width:1600px; margin:0 auto; padding:2rem; }
.page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding-bottom:1.5rem; border-bottom:1px solid var(--border); flex-wrap:wrap; gap:1rem; }
.page-title h1 { font-size:2rem; font-weight:800; }
.page-actions { display:flex; gap:0.75rem; flex-wrap:wrap; }

.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem; margin-bottom:2rem; }
.stat-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:1.5rem; transition:var(--transition); }
.stat-card:hover { transform:translateY(-5px); }
.stat-number { font-size:2rem; font-weight:800; margin-bottom:0.25rem; }
.stat-label { font-size:0.9rem; color:var(--text-muted); }

.filters-bar { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:1.5rem; margin-bottom:2rem; display:flex; gap:1rem; flex-wrap:wrap; align-items:center; }
.filter-group { display:flex; flex-direction:column; gap:0.5rem; flex:1; min-width:200px; }
.filter-group label { font-size:0.85rem; font-weight:600; color:var(--text-muted); }
.filter-input { padding:0.75rem 1rem; background:var(--bg-main); border:1px solid var(--border); border-radius:var(--radius); color:var(--text-main); }
.filter-input:focus { outline:none; border-color:var(--primary); }

.table-container { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); overflow:hidden; }
.table-header { padding:1.5rem; border-bottom:1px solid var(--border); }
.orders-table { width:100%; border-collapse:collapse; }
.orders-table thead { background:var(--bg-main); }
.orders-table th { padding:1rem 1.5rem; text-align:left; font-size:0.85rem; font-weight:600; color:var(--text-muted); text-transform:uppercase; }
.orders-table td { padding:1.25rem 1.5rem; border-bottom:1px solid var(--border); }
.orders-table tbody tr:hover { background:var(--bg-hover); }

/* Badges - ÿ™ŸÖ ÿ™Ÿàÿ≠ŸäÿØ ÿßŸÑŸÉŸÑÿßÿ≥ÿßÿ™ */
.status-badge { display:inline-flex; align-items:center; gap:0.5rem; padding:0.5rem 1rem; border-radius:50px; font-size:0.85rem; font-weight:600; }
.status-pending { background:rgba(245,158,11,0.2); color:#fbbf24; }
.status-accepted { background:rgba(59,130,246,0.2); color:#60a5fa; }
.status-shipped { background:rgba(139,92,246,0.2); color:#a78bfa; }
.status-arrived { background:rgba(16,185,129,0.2); color:#34d399; }
.status-returned { background:rgba(239,68,68,0.2); color:#f87171; }

/* Action Buttons */
.action-buttons { display:flex; gap:8px; align-items:center; }
.btn-details {
  background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none;
  padding:8px 16px; border-radius:8px; cursor:pointer; font-size:0.85rem; font-weight:600;
  display:flex; align-items:center; gap:6px; transition:all 0.3s ease;
}
.btn-details:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(102,126,234,0.6); }
.btn-delete {
  background:linear-gradient(135deg,#f093fb,#f5576c); color:white; border:none;
  padding:8px 16px; border-radius:8px; cursor:pointer; font-size:0.85rem; font-weight:600;
  display:flex; align-items:center; gap:6px; transition:all 0.3s ease;
}
.btn-delete:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(245,87,108,0.6); }

/* Modal - ÿ™ŸÖ ÿ™Ÿàÿ≠ŸäÿØ ÿßŸÑŸÉŸÑÿßÿ≥ÿßÿ™ */
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); }
.modal.active { display:flex; align-items:center; justify-content:center; }
.modal-content { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); max-width:700px; width:90%; max-height:90vh; overflow-y:auto; }
.modal-header { padding:1.5rem 2rem; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.modal-close { width:40px; height:40px; border-radius:var(--radius); border:none; background:var(--bg-hover); color:var(--text-muted); cursor:pointer; font-size:1.5rem; }
.modal-close:hover { background:var(--danger); color:white; }
.modal-body { padding:2rem; }

.detail-section { margin-bottom:2rem; }
.section-title { font-size:1rem; font-weight:700; margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem; padding-bottom:0.75rem; border-bottom:1px solid var(--border); }
.detail-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; }
.detail-item { display:flex; flex-direction:column; gap:0.25rem; }
.detail-label { font-size:0.85rem; color:var(--text-muted); }
.detail-value { font-size:1rem; font-weight:600; }
.products-list { background:var(--bg-main); border-radius:var(--radius); padding:1rem; max-height:300px; overflow-y:auto; }
.item-entry { display:flex; justify-content:space-between; padding:0.75rem 0; border-bottom:1px solid var(--border); }
.item-entry:last-child { border-bottom:none; }
.total-section { background:var(--bg-main); border-radius:var(--radius); padding:1.5rem; margin-top:1.5rem; }
.total-row { display:flex; justify-content:space-between; padding:0.75rem 0; border-bottom:1px solid var(--border); }
.total-row:last-child { border-bottom:none; font-weight:800; font-size:1.25rem; }
.total-value.grand { color:var(--success); }

.form-group { margin-bottom:1.5rem; }
.form-label { display:block; font-size:0.9rem; font-weight:600; margin-bottom:0.5rem; }
.form-input, .form-select, .form-textarea { width:100%; padding:0.75rem 1rem; background:var(--bg-main); border:1px solid var(--border); border-radius:var(--radius); color:var(--text-main); }
.form-input:focus { outline:none; border-color:var(--primary); }
.form-textarea { min-height:100px; resize:vertical; }
.form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; }
.image-preview { margin-top:1rem; border-radius:var(--radius); overflow:hidden; }
.image-preview img { width:100%; max-height:200px; object-fit:cover; }
.modal-footer { padding:1.5rem 2rem; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:0.75rem; }

.status-actions { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:0.75rem; margin-top:1rem; }
.status-btn { padding:0.75rem 1rem; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg-main); color:var(--text-main); font-weight:600; cursor:pointer; transition:var(--transition); display:flex; align-items:center; justify-content:center; gap:0.5rem; }
.status-btn.accept { border-color:rgba(59,130,246,0.5); background:rgba(59,130,246,0.1); color:#60a5fa; }
.status-btn.ship { border-color:rgba(139,92,246,0.5); background:rgba(139,92,246,0.1); color:#a78bfa; }
.status-btn.deliver { border-color:rgba(16,185,129,0.5); background:rgba(16,185,129,0.1); color:#34d399; }
.status-btn.return { border-color:rgba(239,68,68,0.5); background:rgba(239,68,68,0.1); color:#f87171; }
.status-btn:hover { transform:translateY(-2px); }

.loading-state { text-align:center; padding:3rem; }
.loading-spinner { width:50px; height:50px; border:4px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 1rem; }
@keyframes spin { to { transform:rotate(360deg); } }
.notification { position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:var(--radius); font-weight:600; z-index:9999; animation:slideIn 0.3s ease; }
.notification.success { background:var(--success); color:white; }
.notification.error { background:var(--danger); color:white; }
@keyframes slideIn { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
@keyframes slideOut { from { transform:translateX(0); opacity:1; } to { transform:translateX(100%); opacity:0; } }

@media (max-width:768px) {
  .page-header { flex-direction:column; align-items:stretch; }
  .page-actions .btn { flex:1; justify-content:center; }
  .filters-bar { flex-direction:column; }
  .filter-group { width:100%; }
  .table-container { overflow-x:auto; }
  .orders-table { min-width:800px; }
  .action-buttons { flex-direction:column; }
  .btn-details, .btn-delete { width:100%; justify-content:center; }
}
</style>
</head>
<body>

<header>
  <nav class="navbar">
    <div class="logo"><h1><i class="fas fa-chart-line"></i> Amar Dashboard</h1></div>
    <div class="nav-items">
      <a href="index.html" class="btn btn-secondary btn-sm"><i class="fas fa-store"></i> Boutique</a>
      <button class="btn btn-danger btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt"></i> D√©connexion</button>
    </div>
  </nav>
</header>

<main class="admin-container">
  <div class="page-header">
    <div class="page-title"><h1><i class="fas fa-shopping-bag"></i> Gestion des Commandes</h1></div>
    <div class="page-actions">
      <button class="btn btn-success" onclick="openAddProductModal()"><i class="fas fa-plus"></i> Ajouter Produit</button>
      <button class="btn btn-primary" onclick="exportCommandes()"><i class="fas fa-download"></i> Exporter CSV</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="stat-number" id="totalCommandes">0</div><div class="stat-label">Commandes Totales</div></div>
    <div class="stat-card"><div class="stat-number" id="totalRevenu">0 DA</div><div class="stat-label">Revenu Total</div></div>
    <div class="stat-card"><div class="stat-number" id="totalDomicile">0</div><div class="stat-label">Livraison Domicile</div></div>
    <div class="stat-card"><div class="stat-number" id="totalStopdesk">0</div><div class="stat-label">Stop Desk</div></div>
  </div>

  <div class="filters-bar">
    <div class="filter-group"><label>Rechercher</label><input type="text" id="searchInput" class="filter-input" placeholder="N¬∞ commande, client..."></div>
    <div class="filter-group"><label>Type</label><select id="filterType" class="filter-input"><option value="">Tous</option><option value="domicile">Domicile</option><option value="stopdesk">Stop Desk</option></select></div>
    <div class="filter-group"><label>Wilaya</label><select id="filterWilaya" class="filter-input"><option value="">Toutes</option></select></div>
    <div class="filter-group"><label>&nbsp;</label><button class="btn btn-secondary" onclick="clearFilters()">Reset</button></div>
  </div>

  <div class="table-container">
    <div class="table-header"><div class="table-title"><i class="fas fa-list"></i> Liste des Commandes</div></div>
    <table class="orders-table">
      <thead><tr><th>N¬∞ Commande</th><th>Client</th><th>Type</th><th>Wilaya</th><th>Total</th><th>Statut</th><th>Actions</th></tr></thead>
      <tbody id="ordersTableBody"><tr><td colspan="7" class="loading-state"><div class="loading-spinner"></div>Chargement...</td></tr></tbody>
    </table>
  </div>
</main>

<!-- ‚úÖ ŸÖŸàÿØÿßŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ŸÑÿ® - Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑ -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <div class="modal-header"><h2 class="modal-title"><i class="fas fa-receipt"></i> D√©tails Commande</h2><button class="modal-close" onclick="closeDetail()">&times;</button></div>
    <div class="modal-body">
      <div class="detail-section">
        <div class="section-title"><i class="fas fa-tasks"></i> Statut</div>
        <div style="margin-bottom:1rem;"><span class="status-badge status-pending" id="detailStatusBadge">‚è≥ En attente</span></div>
        <div class="status-actions">
          <button class="status-btn accept" onclick="updateOrderStatus('accepted')"><i class="fas fa-check"></i> Accepter</button>
          <button class="status-btn ship" onclick="updateOrderStatus('shipped')"><i class="fas fa-truck"></i> Exp√©dier</button>
          <button class="status-btn deliver" onclick="updateOrderStatus('arrived')"><i class="fas fa-box"></i> Livr√©e</button>
          <button class="status-btn return" onclick="updateOrderStatus('returned')"><i class="fas fa-undo"></i> Retour</button>
        </div>
      </div>
      <div class="detail-section">
        <div class="section-title"><i class="fas fa-user"></i> Client</div>
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">Nom</span><span class="detail-value" id="detailName">‚Äî</span></div>
          <div class="detail-item"><span class="detail-label">T√©l√©phone 1</span><span class="detail-value" id="detailPhone1">‚Äî</span></div>
          <div class="detail-item"><span class="detail-label">T√©l√©phone 2</span><span class="detail-value" id="detailPhone2">‚Äî</span></div>
          <div class="detail-item"><span class="detail-label">Date</span><span class="detail-value" id="detailDate">‚Äî</span></div>
        </div>
      </div>
      <div id="detailWhatsappContainer" style="margin-top: 15px; text-align: center;"></div>
      <div class="detail-section">
        <div class="section-title"><i class="fas fa-map-marker-alt"></i> Livraison</div>
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">Type</span><span class="detail-value" id="detailOrderType">‚Äî</span></div>
          <div class="detail-item"><span class="detail-label">Wilaya</span><span class="detail-value" id="detailWilaya">‚Äî</span></div>
          <div class="detail-item"><span class="detail-label">Commune</span><span class="detail-value" id="detailCommune">‚Äî</span></div>
        </div>
      </div>
      <div class="detail-section">
        <div class="section-title"><i class="fas fa-box-open"></i> Produits</div>
        <div class="products-list" id="detailItems"><p style="text-align:center;color:var(--text-muted);">Aucun produit</p></div>
      </div>
      <div class="total-section">
        <div class="total-row"><span class="total-label">Sous-total</span><span class="total-value" id="detailCartTotal">0 DA</span></div>
        <div class="total-row"><span class="total-label">Livraison</span><span class="total-value" id="detailShipping">0 DA</span></div>
        <div class="total-row"><span class="total-label">Total</span><span class="total-value grand" id="detailTotal">0 DA</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ ŸÖŸàÿØÿßŸÑ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ -->
<div class="modal" id="addProductModal">
  <div class="modal-content">
    <div class="modal-header"><h2 class="modal-title"><i class="fas fa-plus-circle"></i> Ajouter Produit</h2><button class="modal-close" onclick="closeAddProductModal()">&times;</button></div>
    <div class="modal-body">
      <form id="addProductForm">
        <div class="form-group"><label class="form-label">Nom *</label><input type="text" id="productName" class="form-input" required></div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Cat√©gorie *</label><select id="productCategory" class="form-select" required><option value="">S√©lectionner...</option><option value="laptop">Laptop</option><option value="imprimantes">Imprimantes</option><option value="accessoires">Accessoires</option></select></div>
          <div class="form-group"><label class="form-label">Prix (DA) *</label><input type="number" id="productPrice" class="form-input" required min="0" step="0.01"></div>
        </div>
        <div class="form-group"><label class="form-label">Description</label><textarea id="productDescription" class="form-textarea"></textarea></div>
        <div class="form-group"><label class="form-label">Image *</label><input type="file" id="productImageFile" class="form-input" accept="image/*" required><div class="image-preview" id="imagePreview"></div></div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAddProductModal()">Annuler</button>
      <button class="btn btn-success" type="submit" form="addProductForm"><i class="fas fa-save"></i> Enregistrer</button>
    </div>
  </div>
</div>

<script>
// ========== ÿ¨ÿπŸÑ ÿßŸÑÿØŸàÿßŸÑ ŸÖÿ™ÿßÿ≠ÿ© ÿπÿßŸÑŸÖŸäŸãÿß ==========
let allCommandes = [];
window.showDetail = showDetail;
window.deleteCommande = deleteCommande;
window.updateOrderStatus = updateOrderStatus;
window.closeDetail = closeDetail;
window.exportCommandes = exportCommandes;
window.openAddProductModal = openAddProductModal;
window.closeAddProductModal = closeAddProductModal;
window.clearFilters = clearFilters;
window.filterCommandes = filterCommandes;

// ========== ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ==========
function loadCommandes() {
  const tbody = document.getElementById('ordersTableBody');
  if (!tbody) return;
  tbody.innerHTML = '<tr><td colspan="7" class="loading-state"><div class="loading-spinner"></div>Chargement...</td></tr>';
  
  db.collection("commandes").orderBy("date","desc").get().then(snapshot => {
    allCommandes = [];
    snapshot.forEach(doc => allCommandes.push({id:doc.id, ...doc.data()}));
    displayCommandes(allCommandes);
    updateStats();
    initializeWilayaFilter();
  }).catch(err => {
    console.error("‚ùå Erreur:", err);
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:#ef4444;">‚ùå ${err.message}</td></tr>`;
  });
}

// ========== ÿπÿ±ÿ∂ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ==========
function displayCommandes(commandes) {
  const tbody = document.getElementById('ordersTableBody');
  if (!tbody) return;
  if (commandes.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:#94a3b8;">üì≠ Aucune commande</td></tr>`;
    return;
  }
  tbody.innerHTML = commandes.map(cmd => `
    <tr>
      <td class="order-id">${cmd.orderNumber||'N/A'}</td>
      <td>${cmd.firstName||''} ${cmd.lastName||''}</td>
      <td><span class="status-badge ${cmd.orderType==='domicile'?'status-accepted':'status-pending'}">${cmd.orderType==='domicile'?'üè† Domicile':'üè™ Stop Desk'}</span></td>
      <td>${cmd.wilaya||'N/A'}</td>
      <td>${(cmd.grandTotal||0).toFixed(2)} DA</td>
      <td><span class="status-badge ${getStatusClass(cmd.status||'pending')}">${getStatusLabel(cmd.status||'pending')}</span></td>
      <td>
        <div class="action-buttons">
          <button class="btn-details" onclick="showDetail('${cmd.orderNumber}')"><i class="fas fa-eye"></i> D√©tails</button>
          <button class="btn-delete" onclick="deleteCommande('${cmd.orderNumber}')"><i class="fas fa-trash"></i></button>
        </div>
      </td>
    </tr>
  `).join('');
}

// ========== ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ŸÑÿ® ==========
function showDetail(orderNumber) {
  console.log("üîç showDetail:", orderNumber);
  const cmd = allCommandes.find(c => c.orderNumber === orderNumber);
  if (!cmd) { alert("‚ùå Commande introuvable"); return; }
  
  const modal = document.getElementById('detailModal');
  if (!modal) { alert("‚ùå Modal non trouv√©"); return; }
  
  modal.dataset.firebaseId = cmd.id;
  modal.dataset.currentOrderNumber = orderNumber;
  
  // ÿØÿßŸÑÿ© ÿ¢ŸÖŸÜÿ© ŸÑÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÜÿµ
  const setText = (id, val) => { const el=document.getElementById(id); if(el) el.textContent=val??'‚Äî'; };
  
  setText('detailOrderNumber', cmd.orderNumber);
  setText('detailDate', formatDateTime(cmd.date));
  setText('detailName', `${cmd.firstName||''} ${cmd.lastName||''}`);
  setText('detailPhone1', cmd.phone1);
  setText('detailPhone2', cmd.phone2);
  setText('detailWilaya', cmd.wilaya);
  setText('detailCommune', cmd.commune);
  setText('detailOrderType', cmd.orderType === 'domicile' ? 'üè† Domicile' : 'üè™ Stop Desk');
  
  const status = cmd.status || 'pending';
  const badge = document.getElementById('detailStatusBadge');
  if(badge) { badge.textContent = getStatusLabel(status); badge.className = 'status-badge ' + getStatusClass(status); }
  
  const items = document.getElementById('detailItems');
  if(items) {
    if(cmd.cartItems?.length) {
      items.innerHTML = cmd.cartItems.map(it => `<div class="item-entry"><div><strong>${it.name||'?'}</strong><br>${it.price||0} DA √ó ${it.quantity||1}</div><div><strong>${((it.price||0)*(it.quantity||1)).toFixed(2)} DA</strong></div></div>`).join('');
    } else { items.innerHTML = '<p style="text-align:center;color:var(--text-muted);">Aucun produit</p>'; }
  }
  
  setText('detailCartTotal', (cmd.cartTotal||0).toFixed(2));
  setText('detailShipping', (cmd.shippingPrice||0).toFixed(2));
  setText('detailTotal', (cmd.grandTotal||0).toFixed(2));
  
  modal.classList.add('active');
  console.log("‚úÖ Modal affich√©");
}

function closeDetail() { document.getElementById('detailModal')?.classList.remove('active'); }
function getStatusClass(s) { return {pending:'status-pending',accepted:'status-accepted',shipped:'status-shipped',arrived:'status-arrived',returned:'status-returned'}[s] || 'status-pending'; }
function getStatusLabel(s) { return {pending:'‚è≥ En attente',accepted:'‚úì Accept√©e',shipped:'üöö En route',arrived:'üì¶ Arriv√©e',returned:'‚Ü©Ô∏è Retourn√©e'}[s] || '‚è≥ En attente'; }

function updateOrderStatus(newStatus) {
  const modal = document.getElementById('detailModal');
  const fid = modal?.dataset.firebaseId;
  const on = modal?.dataset.currentOrderNumber;
  if(!fid) { alert("‚ùå ID Firebase manquant"); return; }
  if(!confirm(`Changer statut de ${on} √† "${getStatusLabel(newStatus)}"?`)) return;
  
  db.collection("commandes").doc(fid).update({status:newStatus}).then(() => {
    const cmd = allCommandes.find(c => c.orderNumber === on);
    if(cmd) cmd.status = newStatus;
    showNotification('‚úÖ Statut mis √† jour');
    displayCommandes(allCommandes);
    showDetail(on);
  }).catch(err => { console.error(err); alert("‚ùå Erreur mise √† jour"); });
}

function deleteCommande(orderNumber) {
  if(!confirm(`‚ö†Ô∏è Supprimer ${orderNumber}?`)) return;
  const cmd = allCommandes.find(c => c.orderNumber === orderNumber);
  if(!cmd?.id) { alert("‚ùå Introuvable"); return; }
  db.collection("commandes").doc(cmd.id).delete().then(() => {
    allCommandes = allCommandes.filter(c => c.orderNumber !== orderNumber);
    displayCommandes(allCommandes);
    updateStats();
    initializeWilayaFilter();
    showNotification('üóëÔ∏è Supprim√©e');
  }).catch(err => { console.error(err); alert("‚ùå Erreur suppression"); });
}

function filterCommandes() {
  const s = (document.getElementById('searchInput')?.value||'').toLowerCase();
  const t = document.getElementById('filterType')?.value||'';
  const w = document.getElementById('filterWilaya')?.value||'';
  const filtered = allCommandes.filter(c => {
    const ms = (c.orderNumber||'').toLowerCase().includes(s) || (c.firstName||'').toLowerCase().includes(s) || (c.phone1||'').includes(s);
    return ms && (!t||c.orderType===t) && (!w||c.wilaya===w);
  });
  displayCommandes(filtered);
}

function clearFilters() {
  if(document.getElementById('searchInput')) document.getElementById('searchInput').value='';
  if(document.getElementById('filterType')) document.getElementById('filterType').value='';
  if(document.getElementById('filterWilaya')) document.getElementById('filterWilaya').value='';
  filterCommandes();
}

function updateStats() {
  if(document.getElementById('totalCommandes')) document.getElementById('totalCommandes').textContent = allCommandes.length;
  if(document.getElementById('totalRevenu')) {
    const total = allCommandes.reduce((sum,c)=>sum+(c.grandTotal||0),0);
    document.getElementById('totalRevenu').textContent = total.toFixed(2) + ' DA';
  }
  if(document.getElementById('totalDomicile')) document.getElementById('totalDomicile').textContent = allCommandes.filter(c=>c.orderType==='domicile').length;
  if(document.getElementById('totalStopdesk')) document.getElementById('totalStopdesk').textContent = allCommandes.filter(c=>c.orderType==='stopdesk').length;
}

function initializeWilayaFilter() {
  const sel = document.getElementById('filterWilaya');
  if(!sel) return;
  sel.innerHTML = '<option value="">Toutes les wilayas</option>';
  [...new Set(allCommandes.map(c=>c.wilaya).filter(Boolean))].sort().forEach(w => {
    const opt = document.createElement('option'); opt.value=w; opt.textContent=w; sel.appendChild(opt);
  });
}

function exportCommandes() {
  if(!allCommandes.length) { alert("Aucune commande"); return; }
  let csv = 'N¬∞;Client;T√©l√©phone;Wilaya;Type;Total;Statut;Date\n';
  allCommandes.forEach(c => csv += `"${c.orderNumber||''}";"${c.firstName||''} ${c.lastName||''}";"${c.phone1||''}";"${c.wilaya||''}";"${c.orderType||''}";"${(c.grandTotal||0).toFixed(2)}";"${c.status||'pending'}";"${c.date||''}"\n`);
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`commandes_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  showNotification('üì• Export√©!');
}

function openAddProductModal() {
  document.getElementById('addProductModal')?.classList.add('active');
  document.getElementById('addProductForm')?.reset();
  document.getElementById('imagePreview').innerHTML = '';
}
function closeAddProductModal() { document.getElementById('addProductModal')?.classList.remove('active'); }

document.addEventListener('DOMContentLoaded', () => {
  const fi = document.getElementById('productImageFile');
  if(fi) fi.addEventListener('change', function(e) {
    const pv = document.getElementById('imagePreview'); if(!pv) return; pv.innerHTML='';
    if(this.files?.[0]) {
      const r = new FileReader();
      r.onload = ev => { const img=document.createElement('img'); img.src=ev.target.result; img.style.cssText='max-width:100%;max-height:200px;border-radius:8px'; pv.appendChild(img); };
      r.readAsDataURL(this.files[0]);
    }
  });
  
  const form = document.getElementById('addProductForm');
  if(form) form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('productName')?.value.trim();
    const cat = document.getElementById('productCategory')?.value;
    const desc = document.getElementById('productDescription')?.value.trim();
    const price = parseFloat(document.getElementById('productPrice')?.value);
    const file = document.getElementById('productImageFile')?.files?.[0];
    if(!name||!cat||!price||!file||isNaN(price)||price<=0) { alert("‚ö†Ô∏è Remplissez tous les champs"); return; }
    
    try {
      showNotification('üì§ Upload...');
      const ref = storage.ref().child(`produits/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g,'_')}`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      await db.collection("produits").add({name,image:url,category:cat,description:desc||'',price,dateAdded:new Date().toISOString()});
      showNotification('‚úÖ Produit ajout√©!');
      closeAddProductModal(); form.reset(); document.getElementById('imagePreview').innerHTML='';
    } catch(err) { console.error(err); alert("‚ùå "+err.message); }
  });
  
  document.getElementById('searchInput')?.addEventListener('input', filterCommandes);
  document.getElementById('filterType')?.addEventListener('change', filterCommandes);
  document.getElementById('filterWilaya')?.addEventListener('change', filterCommandes);
  
  loadCommandes();
});

function showNotification(msg) {
  const n = document.createElement('div'); n.className='notification success'; n.textContent=msg; n.style.cssText='position:fixed;top:20px;right:20px;padding:1rem 1.5rem;border-radius:12px;font-weight:600;z-index:9999;animation:slideIn 0.3s ease;background:var(--success);color:white';
  document.body.appendChild(n); setTimeout(()=>{n.style.animation='slideOut 0.3s ease';setTimeout(()=>n.remove(),300);},3000);
}
function formatDateTime(d) { if(!d) return '‚Äî'; try{return new Date(d).toLocaleString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}catch{return'‚Äî'} }

if(sessionStorage.getItem('adminLogged')!=='true') window.location.href='login.html';
function logout() { sessionStorage.removeItem('adminLogged'); window.location.href='login.html'; }
</script>
</body>
</html>

